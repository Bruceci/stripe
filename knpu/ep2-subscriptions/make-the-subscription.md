# Make the Subscription

Open up the Stripe docs and go down the page until you find subscriptions. There's a nice little getting started section which is cool, but I'm going to go straight down to the detailed guide. There's a lot of stuff here that you're going to reference in the future. We'll cover a lot of it, but let's just start with the basics. First, step one is done, we've already created our plan so we're going down to step two which I subscribing your customers. If you look at the code that does this, it's pretty interesting. Subscribing one of your Strip customers to a plan is as simple as, when you create the customer, passing a plan key set to that plan ID. Now we're actually going to do it a slightly different way, but the most important thing to realize is that this creates a new object in Stripe called a subscription.

If you keep reading down here, you'll eventually learn more about the lifecycle of a subscription. The most important thing that I want you to realize now is that when you create a subscription, Stripe creates an invoice and charges that invoice immediately. Now, you might remember from our first part in Stripe that we also created invoices whenever we were creating charges for individual products. Let's look at which important objects we have in play at this point. Open up the Stripe API docs. So far, when we check out with individual products we do a couple things. First, we create a customer. Second, we create some invoice items. Then finally, we create an invoice and pay that invoice. When you create an invoice it automatically adds any unpaid invoice items to it.

Now with subscriptions there's two new things coming in. We already have plans and now we're going to create a subscription and this subscription will use invoices behind the scenes. We'll talk all about that as we go, right now we just need to create a subscription object. Click subscriptions and go down to create a subscription. You see, it's really simple. A subscription is just between a customer and a specific plan. When we submit out checkout form here with our credit card information it goes to order controller check out action. In here we can see ... Ultimately, we do all of the work of charging the customer inside of this charge customer method which is down here. In here you can see we are creating the customer, adding the invoice items, and creating the invoice. Simple.

Now that we might have a subscription plan we need to create that. Down here, before we create the invoice, let's say if cart, arrow, get subscription plan, then we know we need to create a subscription. Anytime that we do something across Stripe's API, we use this hand Stripe client object that I have set up because it takes care of setting our API key for us. Inside of here let's create a new public function called create invoice. We'll pass it the user ... Create subscription, we'll pass it the user. Also the subscription plan object that we want to subscribe them to. Now, if we go back to the Stripe API docs, let's steal the code here for creating a subscription and go back, paste that, and sign that to a subscription variable. Then for the customer we can say user, arrow, get Stripe customer ID. That's something we set up in the first episode. Whenever we create a Stripe customer we save it on our user table. For the plan, we'll just plan, arrow, get plan ID, then we'll return that subscription.

Now, order controller. We can simply say Stripe client, which is a variable we have up here already, arrow, create subscription. We'll pass it user, which is our current user object, and then cart, arrow, get subscription plan and that's it. It's that simple to create a subscription, but there's a little bit of a gotcha here. Remember, we just looked at how subscriptions create invoices. When you create an invoice, an invoice will automatically collect any existing invoice items that haven't been paid yet. If the user has a subscription plan, then an invoice will be created right here which means that if we create another invoice below that, that invoice will be empty and you'll actually get an error because there's nothing left to pay.

What we actually want to do here is put the create invoice into the else so that if there is a subscription plan, it will create the invoice and if there is not a subscription plan, then we still need to create the invoice. This will allow us to actually buy a subscription plan and individual products. Let's go back to our homepage. Let's actually also add some sheer shears to our cart, so now we have a mixture of an individual product and a subscription. Let's fill in our fake credit card information, hit check out, and ... Cool, no errors. The real proof is inside of our dashboard. Let's hit payments, perfect, you can see the one for $124. Take a more interesting look, let's click into our customer. When we checked out, it created our customer, it associated the card with it, we now have an active subscription and this was all done via this one invoice, which itself was the subscription plus the one-time product. This is awesome.

Now that our subscription has successfully saved in Stripe, we also need to update our user on our site so that we know that the currently logged in user is subscribed to one of our subscription plans.

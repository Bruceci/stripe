# User Has Subscription

Whether you're buying products or you're doing subscriptions, Stripe handles most of the heavy lifting for us, but there are a few things that we want to keep in our database. For example, in our user table, which is modeled by this user class, we store the Stripe customer ID. We create the customer in Stripe and that has most of the informations, but we keep a reference back to our user so we can look up that Stripe customer through the Stripe API later.

We need to do the same thing for the subscription. We just created a subscription object. It has an ID, and we need to associate that Stripe subscription ID with our user, so that we know that our user is subscribed to that particular plan. There are a number of different ways to do that. I created a new subscription table. I'm going to open up a new tab in my Terminal ... and use MySQL to login to my database, just to show you what it looks like. Notice I have the fos_user table. That's the user table, and I now have a new subscription table. A couple of important things here. The subscription table has a relationship back to the user table, so that's a foreign key. Each subscription belongs to exactly one user. In the subscription table we keep track of a few things. First, we keep track of the Stripe subscription ID, so that's the individual instance of this user's subscription. Also, the Stripe plan ID so that we know, really quickly, which of the two plans they're subscribed to, and also a couple of other pieces of information that are going to help us manage what happens when a subscription is cancelled or expires.

When a user completes a subscription, we need to create a new row in this table and make sure that this information is updated correctly. That means we need to create a new subscription object and save it to the database. As convenience, once we create the subscription object and associate it with our user, if we have our user object, we can very easily fetch their subscription if they have one via this subscription property. Let me show you what I mean.

When you're logged in you have a new Account section that I created. This is going to contain information about our subscription, but right now it's just a bunch of hard-coded information. It says Subscription, None. Open up this template in app, resources, views, profile, account.html.twig. Instead of just saying none for the subscription, let's add an if statement. If app.user, that would be the currently logged-in user, .subscription, then we know they have a subscription, else we know they don't have a subscription. If they do, let's create a new little label that says Active. If they don't, let's create a label that says None. If we refresh right now, that's going to say None, because when we just checked that a second ago, we did not create the subscription in our subscription table, so even though our customer technically has a subscription Stripe, we didn't actually record that on our database yet. That's what we need to fix.

Where do we need to fix it? It needs to get fixed right here. This is charge customer that we've been working on, and right after we create the subscription in Stripe, we need to associate that ... We need to update our database to show that the user has a subscription. Instead of putting the code right here, I'm actually going to put this inside of our subscription helper. This class is going to take care of everything that has to do with doing work on subscriptions. We'll be adding more and more helper methods to it. Let's set a new one at the bottom called public function addSubscriptionToUser. The idea is that this will accept a Stripe slash ... Come on in. This is raw audio so I can talk right through it.

Okay.

Yeah, yeah. Thank you. This will take in a Stripe\Subscription object and a User object and it'll update the database to associate those. In other words, it will create that new record in the subscription table with the foreign key back to the user table. The Stripe\Subscription is what we're going to get back after we create a new subscription, so it's going to have all kinds of information on it like its ID and information about the plan that it's associated with, so that's really important.

Now inside of here, the user might already be associated with an expired subscription. First we're going to check for that. We're going to say subscription equals user arrow getSubscription. If there's already a subscription on the table, then we're just going to update that instead of creating a new one. If they don't have a past subscription, then let's create a new one. Subscription equals newSubscription, subscription setUser User.

The only other thing we need to is actually update the fields on this subscription object. In other words, we need to make sure that the Stripe subscription ID is set and the Stripe plan ID is set. To do that, I'm actually going to add a new method instead of the Subscription class itself called public function activateSubscription. This will take in the information it needs, specifically the Stripe plan ID and the Stripe subscription ID. Then we'll say this arrow stripePlanId equals stripePlanId. This arrow stripeSubscriptionId equals stripeSubscriptionID. I'm also going to say this arrow endsAt equals null. We're going to talk more about this later, but by setting endsAt to null, that's going to mean that this subscription is currently active. It's not cancelled or anything like that.

Back in subscription helper, we can say subscription arrow activateSubscription. We need to pass it the Stripe plan ID and the Stripe subscription ID. Remember, we're dealing with the Stripe subscription object, which is going to look like this. It has an ID property which is the subscription ID. It also has a plan property with an ID sub-property, which will be the plan ID. In other words, we can use stripeSubscription arrow plan arrow id for the plan ID, and stripeSubscription arrow id to get the Stripe subscription ID. It's that simple.

Finally, now that we have this subscription object updated with the correct information, we just need to actually make the insert or update query to the database. Since we're using Doctrine, I'm going to use dependency injection to inject the entity manager. I'll create an entity manager argument and then set a new em property on it. For Symphony users, this service is using auto-wiring, so because I type-hinted this with entity manager, it's going to automatically inject that entity manager in here. Finally in the bottom we're going to say this arrow em arrow persist subscription, and I'm saying this arrow em arrow flush subscription. I'm passing the subscription to flush specifically so that it only saves that entity. It doesn't also save any other entities that might currently be modified.

Finally, with all of this set up, we can go back to order controller and call this method. First, we actually need the Stripe subscription. Remember, the Stripe client here, when we call createSubscription, it creates that Stripe subscription and actually returns it. Inside order controller when we call that method, we can set it to stripeSubscription. Below, we'll say this arrow get subscription arrow helper, and then we'll call that new addSubscriptionToUser method, passing it the Stripe subscription object and the currently logged-in user. That is it.

We've organized our code in a few different places, but ultimately this simply makes sure that there is a new subscription row in our table that's associated with this user, and that that row has the most up-to-date information about the subscription. Let's go try it out ... by grabbing another subscription. In real life, once a user has a subscription, you would probably prevent them from getting another one ... but for simplicity we're going to let our customers get many subscriptions. Fill out your fake credit card information. Hit checkout. No errors and in Account, our subscription is now active, or said differently, we now have a row in our subscription table linked back to our user ID with our correct subscription ID and our Stripe plan ID. We have a subscription in Stripe and we know that the user has a subscription in our database.
